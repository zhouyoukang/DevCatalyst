---
trigger: always_on
---

# 执行引擎

## 执行原则
- 按最优路线一次性推进到可验收产物，不中断不分段
- 写入前先用只读工具收集信息（可并行），写操作串行合并
- 同一文件用 `multi_edit` 一次完成

## 终端规则（Windows）
- Shell 设为 `"Windows PowerShell"`（5.1），启用 `shellIntegration`
- 优先文件工具（`read_file`/`edit`/`find_by_name`/`grep_search`）替代终端
- 命令拆短（3-6条），禁止长管道/并行命令组
- 卡顿/超时 → 立即切换文件工具方案

## Hooks 策略
- **Python/Node.js hooks**：安全可用（日志、格式化、安全检查）
- **PowerShell hooks**：**绝对禁止**（铁证：干扰终端提示符检测，导致全窗口卡死）
- Hooks 三层合并：system → user → workspace
- Pre-hooks 可通过 exit code 2 阻止操作

## 全局配置保护
修改以下路径前必须：**评估影响 → 备份 → 验证**
| 路径 | 影响 | 风险 |
|------|------|------|
| `~/.codeium/windsurf/hooks.json` | 所有窗口每条命令 | 🔴极高 |
| `~/.codeium/windsurf/*` | 所有项目 | 🔴极高 |
| IDE `settings.json` | 所有窗口 | 🟡高 |
| `.vscode/settings.json` | 当前项目 | 🟢中 |

## 开发管线（/dev 工作流）
| Phase | 模式 | 规则 |
|-------|------|------|
| 0-2 分析/设计 | 只读 | 可并行 |
| 3 实现 | 写入 | 串行，multi_edit |
| 4 构建 | 终端 | 非阻塞，最多2轮修复 |
| 5 部署 | 终端 | 逐步确认 |
| 6-7 文档/总结 | 写入 | 可并行 |

失败处理：编译失败→修复（2轮）| 环境缺失→跳过标记 | 验证失败→报告不自动修

## 错误处理
- 用户中断 = 卡顿信号 → 换方案，不问原因
- Bug修复：每次只改一个变量，确认后再改下一个
- 恢复优先于重建：修改无效 → 先恢复原状再分析
- 同一问题2次失败 → 升级到L2（查文档/搜索）

## 网络故障
1. 第一次失败 → 换URL重试
2. 连续2次失败 → 立即反馈用户："可能需要VPN"

## 规则预算制（DevCatalyst v5.0）
```
always-on 规则总字符数 ≤ 6000 | 新增必须经过变更协议
```
### 预算执行
- **加规则前**：统计当前 `.windsurf/rules/` 中 always-on 文件总字符数
- **超预算时**：压缩现有规则 | 降级低频规则到Memory | 拒绝并解释
- **`/evolve` 编译**：定期去重+压缩+冲突扫描+降级未使用规则

### 规则生命周期
```
用户提出 → Memory观察(experimental) → 验证3+次 → 规则文件(validated) → 长期未触发 → 降回Memory
```

### 固化路由
| 类型 | 正确位置 | 判断依据 |
|------|---------|----------|
| AI通用行为 | 规则文件 | 跨项目通用+验证过+预算内 |
| 操作步骤 | Skill/Workflow | 有明确步骤序列 |
| 项目知识 | Memory/AGENTS.md | 项目特定 |
| 一次性经验 | Memory | 不确定是否会复用 |

## Windsurf 高级功能（善用）
- **Codemaps**：生成可分享的代码结构图，帮助理解大型代码库
- **Worktrees**：多个Cascade同时编辑时隔离工作区
- **Vibe and Replace**：AI驱动的查找替换，对每个匹配应用自然语言提示
- **Knowledge Base**：自定义知识库，提供持久上下文
- **Linter集成**：自动修复生成代码的lint错误（免费）

## 严禁
- 禁止说「我做不到」而不先搜索
- 禁止有价值发现不记录Memory
- 禁止只改单文件忽略关联影响
- 禁止网络错误默默跳过不反馈
- 禁止在最后一步调用可能超时的工具
